<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>åº«å­˜ç®¡ç† - åº«å­˜æ‘˜è¦èˆ‡åˆ†ä½ˆåœ– (å«3Dç«‹é«”é¤…ç‹€åœ–)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- å¦‚æœä½ æƒ³ç”¨ FontAwesome iconï¼Œå¯ä»¥åŠ å…¥ä»¥ä¸‹ CDNï¼ˆå¯é¸ï¼‰ -->
  <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" /> -->
  <script src="https://cdn.jsdelivr.net/npm/vue@3.2.47/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center; /* æ°´å¹³ç½®ä¸­ */
      align-items: center;     /* å‚ç›´ç½®ä¸­ */
      background-color: #f8f9fa; /* Bootstrap bg-light è‰²èª¿ */
    }
    #app {
      max-width: 900px;
      width: 100%;
      padding: 20px 15px;
      box-sizing: border-box;
    }
  </style>

  <style>
    body, html, #app {
      height: 100%;
      margin: 0;
      padding: 0;
      background-color: #f8f9fa;
    }
    .low-stock {
      color: #dc3545;
      font-weight: bold;
    }
    .chart-container {
      position: relative;
      width: 100%;
      max-width: 900px;
      margin: 0 auto 2rem auto;
    }
    /* ä¸»å®¹å™¨èª¿æ•´ï¼ŒæŸ±ç‹€åœ–è¼ƒå¯¬ */
    .bar-chart-box {
      max-width: 900px;
      margin: 0 auto 2rem auto;
    }
    /* é¤…ç‹€åœ–ç½®æ–¼æŸ±ç‹€åœ–ä¸‹æ–¹ï¼Œç½®ä¸­ä¸”å¯¬åº¦è¼ƒå° */
    .pie-chart-box {
      max-width: 600px;
      margin: 0 auto 3rem auto;
    }
    /* æ–°å¢ï¼šè³‡æ–™è¡¨åŠä½åº«å­˜æ¸…å–®ç½®ä¸­ */
    .table-responsive {
      display: flex;
      justify-content: center;
    }
    .table-responsive > table {
      margin: 0 auto;
    }
    .list-group {
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
  </style>
</head>
<body>
  <div id="app" class="container py-4" style="max-width: 900px;">
    <h1 class="mb-4 text-center">åº«å­˜ç®¡ç† - åº«å­˜æ‘˜è¦èˆ‡åˆ†ä½ˆåœ–</h1>

    <!-- æ–°å¢æ­¡è¿è¨Šæ¯èˆ‡ç™»å‡ºæŒ‰éˆ• -->
    <div v-if="token && !authErrorMessage" class="mb-3 d-flex justify-content-between align-items-center">
      <div>æ­¡è¿ï¼Œ<strong>{{ currentUser }}</strong></div>
      <button class="btn btn-outline-danger btn-sm" @click="logout">ç™»å‡º</button>
    </div>

    <div v-if="authErrorMessage" class="alert alert-danger text-center">
      {{ authErrorMessage }}
    </div>

    <div v-if="showLoginForm" class="card mx-auto mb-4" style="max-width: 400px;">
      <div class="card-body">
        <h5 class="card-title text-center mb-3">è«‹æŒ‰ã€ç§‘åˆ¥ã€‘å¿«é€Ÿç™»å…¥/è¼¸å…¥å¸³è™Ÿå¯†ç¢¼ï¼Œä»¥å–å¾—æˆæ¬ŠæŸ¥è©¢</h5>

        <!-- å¿«é€Ÿç™»å…¥å¡ç‰‡ -->
        <div class="mb-3 d-flex flex-wrap justify-content-center gap-2">
          <button v-for="card in quickLoginCards" :key="card.username" type="button" class="btn btn-outline-primary" 
            @click="quickLogin(card)">
            {{ card.label }}
          </button>
        </div>

        <div class="mb-3">
          <input v-model="loginForm.username" class="form-control" placeholder="å¸³è™Ÿ" />
        </div>
        <div class="mb-3">
          <input v-model="loginForm.password" type="password" class="form-control" placeholder="å¯†ç¢¼" />
        </div>
        <div class="d-grid">
          <button @click="login" class="btn btn-primary" :disabled="loginLoading">
            {{ loginLoading ? 'ç™»å…¥ä¸­...' : 'ç™»å…¥' }}
          </button>
        </div>
        <div class="mt-3 text-danger text-center" v-if="loginError">{{ loginError }}</div>
      </div>
    </div>

    <div v-if="token && !authErrorMessage">
      <div class="mb-4 d-flex justify-content-between align-items-center">
        <h4><span style="font-size: 1.5em; color: #b81414;">{{ currentDepName }}</span> åº«å­˜æ‘˜è¦</h4>
        <button class="btn btn-outline-primary" @click="fetchMaterialsSummary(true)" :disabled="loadingSummary">
          {{ loadingSummary ? 'æ›´æ–°ä¸­...' : 'æ›´æ–°åº«å­˜æ‘˜è¦' }}
        </button>
      </div>

      <div v-if="loadingSummary" class="text-center mb-3">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
        </div>
      </div>

      <div v-if="materials.length === 0 && !loadingSummary" class="alert alert-info">
        ç›®å‰æ²’æœ‰ä»»ä½•ç‰©æ–™è³‡æ–™ã€‚
      </div>

      <div v-if="materials.length > 0">
        <div class="table-responsive mb-4">
          <table class="table table-striped table-bordered align-middle">
            <thead class="table-light">
              <tr>
                <th>ç‰©æ–™ç·¨è™Ÿ</th>
                <th>æ¢ç¢¼</th>
                <th>åç¨±</th>
                <th>åˆ†é¡</th>
                <th>ç•¶å‰åº«å­˜</th>
                <th>å®‰å…¨åº«å­˜</th>
                <th>å–®ä½</th>
                <th>å­˜æ”¾åœ°é»</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="m in materials" :key="m.id" :class="{'low-stock': m.current_stock <= m.safety_stock}">
                <td>{{ m.item_id }}</td>
                <td>{{ m.barcode || '-' }}</td>
                <td>{{ m.name }}</td>
                <td>{{ m.category }}</td>
                <td>{{ m.current_stock }}</td>
                <td>{{ m.safety_stock }}</td>
                <td>{{ m.unit }}</td>
                <td>{{ m.notes }}</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="mb-4">
          <h5>âš ï¸ ä½å®‰å…¨åº«å­˜ç‰©æ–™</h5>
          <div v-if="lowStockMaterials.length === 0" class="alert alert-success">
            ç›®å‰æ²’æœ‰ä½æ–¼å®‰å…¨åº«å­˜çš„ç‰©æ–™ã€‚
          </div>
          <ul v-else class="list-group">
            <li v-for="m in lowStockMaterials" :key="m.id" class="list-group-item list-group-item-danger">
              {{ m.name }} ({{ m.item_id }}) - åº«å­˜ï¼š{{ m.current_stock }} {{ m.unit }}ï¼Œå®‰å…¨åº«å­˜ï¼š{{ m.safety_stock }}
            </li>
          </ul>
        </div>

        <div class="bar-chart-box">
          <h5>ğŸ“Š åº«å­˜åˆ†ä½ˆæŸ±ç‹€åœ– (ç•¶å‰åº«å­˜èˆ‡å®‰å…¨åº«å­˜ä¸¦åˆ—)</h5>
          <div class="chart-container">
            <canvas id="barStockChart"></canvas>
          </div>
        </div>

        <div class="pie-chart-box">
          <h5>ğŸ“Š 3Dç«‹é«”åº«å­˜åˆ†ä½ˆé¤…ç‹€åœ– (ä¾åˆ†é¡åˆ¥)</h5>
          <div class="chart-container">
            <canvas id="pieStockChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div v-if="!token && !showLoginForm && !authErrorMessage" class="alert alert-warning text-center">
      å°šæœªå–å¾—æˆæ¬Šï¼Œè«‹è¯çµ¡ç³»çµ±ç®¡ç†å“¡ã€‚
    </div>

    </div>
  </div>

<script>
  const { createApp } = Vue;
  createApp({
    data() {
      return {
        apiUrl: localStorage.getItem('apiUrl') || "https://fsvs-isd.github.io/materials-management/api",
        token: localStorage.getItem('token') || "",
        authErrorMessage: "",
        showLoginForm: false,
        loginForm: { username: "", password: "" },
        loginLoading: false,
        loginError: "",

        materials: [],
        lowStockMaterials: [],
        loadingSummary: false,

        barStockChart: null,
        pieStockChart: null,

        quickLoginCards: [
        ],

        depNameMap: {
          dep1: 'å•†ç¶“ç§‘',
          dep2: 'æœƒäº‹ç§‘',
          dep3: 'åœ‹è²¿ç§‘',
          dep4: 'è§€å…‰ç§‘',
          dep5: 'è³‡è™•ç§‘',
          dep6: 'æ©Ÿæ¢°ç§‘',
          dep7: 'é›»åœ–ç§‘',
          dep8: 'å®¤è¨­ç§‘',
          dep9: 'å®¶è¨­ç§‘'
        },

        currentUsername: '', // ç›®å‰ç™»å…¥å¸³è™Ÿ
      };
    },
    computed: {
      currentUser() {
        if (!this.token) return '';
        try {
          const payload = JSON.parse(atob(this.token.split('.')[1]));
          this.currentUsername = payload.sub || '';
          return this.currentUsername;
        } catch {
          return '';
        }
      },
      currentDepName() {
        return this.depNameMap[this.currentUsername] || '';
      }
    },
    watch: {
      token(newToken) {
        this.updateTitle();
      },
      currentUsername(newUsername) {
        this.updateTitle();
      }
    },
    mounted() {
      this.updateTitle();
      window.addEventListener('message', this.handleParentMessage);
      if (this.token) {
        if (this.isTokenExpired(this.token)) {
          this.tryAutoAuthOrLogin();
        } else {
          this.fetchMaterialsSummary().then(() => {
            this.authErrorMessage = "";
            this.showLoginForm = false;
          }).catch(() => {
            this.tryAutoAuthOrLogin();
          });
        }
      } else {
        this.tryAutoAuthOrLogin();
      }
      const observer = new MutationObserver(() => {
        this.sendHeightToParent();
      });
      observer.observe(document.body, { childList: true, subtree: true, attributes: true });
    },
    beforeUnmount() {
      window.removeEventListener('message', this.handleParentMessage);
    },
    methods: {
      updateTitle() {
        const dep = this.currentDepName;
        if (dep) {
          document.title = `${dep} åº«å­˜ç®¡ç† - åº«å­˜æ‘˜è¦èˆ‡åˆ†ä½ˆåœ– (å«3Dç«‹é«”é¤…ç‹€åœ–)`;
        } else {
          document.title = `åº«å­˜ç®¡ç† - åº«å­˜æ‘˜è¦èˆ‡åˆ†ä½ˆåœ– (å«3Dç«‹é«”é¤…ç‹€åœ–)`;
        }
      },
      isTokenExpired(token) {
        try {
          const payload = JSON.parse(atob(token.split('.')[1]));
          const now = Math.floor(Date.now() / 1000);
          return payload.exp && payload.exp < now;
        } catch {
          return true;
        }
      },
      logout() {
        this.token = "";
        localStorage.removeItem('token');
        this.materials = [];
        this.lowStockMaterials = [];
        this.showLoginForm = true;
        this.authErrorMessage = "";
        if (this.barStockChart) {
          this.barStockChart.destroy();
          this.barStockChart = null;
        }
        if (this.pieStockChart) {
          this.pieStockChart.destroy();
          this.pieStockChart = null;
        }
        this.$nextTick(() => {
          this.sendHeightToParent();
          this.updateTitle();
        });
      },
      handleParentMessage(event) {
        if (event.origin === window.location.origin || event.origin === "null") {
          if (event.data && (event.data.type === 'inventoryUpdated' || event.data.type === 'refreshInventory')) {
            this.fetchMaterialsSummary(true);
          }
        }
      },
      sendHeightToParent() {
        const height = document.documentElement.scrollHeight || document.body.scrollHeight;
        window.parent.postMessage({ type: 'adjustHeight', height: height }, '*');
      },
      async tryAutoAuthOrLogin() {
        try {
          const token = await this.autoAuthorize();
          if (token && !this.isTokenExpired(token)) {
            this.token = token;
            localStorage.setItem('token', token);
            this.authErrorMessage = "";
            this.showLoginForm = false;
            await this.fetchMaterialsSummary();
          } else {
            this.token = "";
            localStorage.removeItem('token');
            this.showLoginForm = true;
            this.authErrorMessage = "";
            this.updateTitle();
          }
        } catch (e) {
          this.token = "";
          localStorage.removeItem('token');
          this.showLoginForm = true;
          this.authErrorMessage = "";
          this.updateTitle();
        }
      },
      async autoAuthorize() {
        try {
          const res = await axios.get(`${this.apiUrl}/auto-auth`);
          if (res.data && res.data.access_token) {
            return res.data.access_token;
          }
        } catch (e) {}
        return null;
      },
      login() {
        this.loginLoading = true;
        this.loginError = "";
        axios.post(`${this.apiUrl}/login`, {
          username: this.loginForm.username,
          password: this.loginForm.password
        }).then(res => {
          this.token = res.data.access_token;
          localStorage.setItem('token', this.token);
          this.authErrorMessage = "";
          this.showLoginForm = false;
          this.fetchMaterialsSummary();
        }).catch(err => {
          this.loginError = "ç™»å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªå¸³è™Ÿå¯†ç¢¼";
          console.error("Login error:", err);
        }).finally(() => {
          this.loginLoading = false;
          this.$nextTick(() => {
            this.sendHeightToParent();
            this.updateTitle();
          });
        });
      },
      async quickLogin(card) {
        this.loginForm.username = card.username;
        this.loginForm.password = card.password;
        await this.login();
      },
      async fetchMaterialsSummary(forceReload = false) {
        if (!this.token) return Promise.reject();
        this.loadingSummary = true;
        try {
          const url = forceReload ? `${this.apiUrl}/materials?timestamp=${Date.now()}` : `${this.apiUrl}/materials`;
          const res = await axios.get(url, {
            headers: { Authorization: `Bearer ${this.token}` },
          });
          this.materials = res.data || [];
          this.materials.forEach(m => {
            m.current_stock = parseInt(m.current_stock) || 0;
            m.safety_stock = parseInt(m.safety_stock) || 0;
          });

          this.lowStockMaterials = this.materials.filter(m => m.current_stock <= m.safety_stock);
          this.renderCharts();
          this.authErrorMessage = "";
          this.showLoginForm = false;
          this.loadingSummary = false;
          this.$nextTick(() => {
            this.sendHeightToParent();
          });
          return Promise.resolve();
        } catch (e) {
          if (e.response && e.response.status === 401) {
            this.logout();
            this.authErrorMessage = "æˆæ¬Šå·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥ã€‚";
          } else {
            this.authErrorMessage = "è®€å–ç‰©æ–™è³‡æ–™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
          }
          this.showLoginForm = true;
          this.loadingSummary = false;
          this.$nextTick(() => {
            this.sendHeightToParent();
          });
          return Promise.reject();
        }
      },
      renderCharts() {
        this.renderBarChart();
        this.renderPieChart3D();
      },
      renderBarChart() {
        if (this.barStockChart) {
          this.barStockChart.destroy();
        }
        const labels = this.materials.map(m => m.name);
        const currentStockData = this.materials.map(m => m.current_stock);
        const safetyStockData = this.materials.map(m => m.safety_stock);

        const ctx = document.getElementById('barStockChart').getContext('2d');
        this.barStockChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [
              {
                label: 'ç•¶å‰åº«å­˜',
                data: currentStockData,
                backgroundColor: 'rgba(75, 192, 192, 0.7)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
              },
              {
                label: 'å®‰å…¨åº«å­˜',
                data: safetyStockData,
                backgroundColor: 'rgba(255, 159, 64, 0.7)',
                borderColor: 'rgba(255, 159, 64, 1)',
                borderWidth: 1
              }
            ]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  precision: 0
                },
                title: {
                  display: true,
                  text: 'åº«å­˜æ•¸é‡'
                }
              },
              x: {
                title: {
                  display: true,
                  text: 'ç‰©æ–™åç¨±'
                }
              }
            },
            plugins: {
              legend: { display: true, position: 'top' },
              tooltip: {
                callbacks: {
                  label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y}`
                }
              }
            }
          }
        });
      },
      renderPieChart3D() {
        if (this.pieStockChart) {
          this.pieStockChart.destroy();
        }
        const categoryMap = {};
        this.materials.forEach(m => {
          const currentStock = m.current_stock;
          if (!isNaN(currentStock)) {
            if (!categoryMap[m.category]) {
              categoryMap[m.category] = 0;
            }
            categoryMap[m.category] += currentStock;
          }
        });
        const labels = Object.keys(categoryMap);
        const data = Object.values(categoryMap);

        const baseColors = [
          '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
          '#9966FF', '#FF9F40', '#E7E9ED', '#71B37C',
          '#F67019', '#00A6B4'
        ];
        const backgroundColors = baseColors.slice(0, labels.length).map(c => c);

        const ctx = document.getElementById('pieStockChart').getContext('2d');
        this.pieStockChart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: labels,
            datasets: [{
              label: 'åˆ†é¡åº«å­˜æ¯”ä¾‹',
              data: data,
              backgroundColor: backgroundColors,
              borderColor: '#fff',
              borderWidth: 2,
              hoverOffset: 30,
              offset: 10
            }]
          },
          options: {
            responsive: true,
            cutout: '40%',
            plugins: {
              legend: {
                position: 'right',
                labels: {
                  boxWidth: 20,
                  padding: 10
                }
              },
              tooltip: {
                callbacks: {
                  label: ctx => {
                    const label = ctx.label || '';
                    const value = ctx.parsed || 0;
                    const total = ctx.dataset.data.reduce((sum, val) => sum + val, 0);
                    const percent = total ? ((value / total) * 100).toFixed(1) : 0;
                    return `${label}: ${value} (${percent}%)`;
                  }
                }
              }
            },
            animation: {
              animateRotate: true,
              animateScale: true
            }
          },
          plugins: [{
            id: 'shadow',
            beforeDraw(chart) {
              const ctx = chart.ctx;
              ctx.save();
              ctx.shadowColor = 'rgba(0,0,0,0.25)';
              ctx.shadowBlur = 15;
              ctx.shadowOffsetX = 0;
              ctx.shadowOffsetY = 5;
              ctx.restore();
            }
          }]
        });
      }
    }
  }).mount('#app');
</script>
</body>
</html>
