<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>出入庫管理(掃碼) - 校園物料管理系統</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/vue@3.2.31/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@1.1.3/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/jspdf-font-standard-chinese/dist/jspdf-font-standard-chinese.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 1rem;
      box-sizing: border-box;
      background-color: #f5f7fb;
      font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif;
    }
    #app.container {
      max-width: 720px;
      width: 100%;
      background: white;
      padding: 1.5rem 2rem;
      border-radius: 0.75rem;
      box-shadow: 0 0.125rem 0.75rem rgba(0,0,0,0.1);
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }
    h3 {
      margin-bottom: 1.5rem;
      color: #4a6fdc;
      flex-shrink: 0;
    }
    .form-control {
      font-size: 1.1rem;
    }
    .btn-primary {
      min-width: 120px;
    }
    .scan-input {
      letter-spacing: 0.15em;
      font-weight: 600;
      font-size: 1.25rem;
      text-align: center;
      padding: 0.5rem;
      border-radius: 0.5rem;
      border: 2px solid #4a6fdc;
      outline-offset: 2px;
      transition: border-color 0.3s;
    }
    .scan-input:focus {
      border-color: #2a4db7;
      box-shadow: 0 0 8px rgba(42, 77, 183, 0.5);
    }
    .alert {
      margin-top: 1rem;
      flex-shrink: 0;
    }
    .record-list {
      max-height: 300px;
      overflow-y: auto;
      margin-top: 1rem;
      flex-grow: 1;
    }
    .record-list table {
      font-size: 0.9rem;
      white-space: nowrap;
    }
    .record-list th, .record-list td {
      vertical-align: middle;
    }
    .btn-clear {
      margin-top: 1rem;
    }
    .form-select {
      font-size: 1rem;
    }
    .loading-spinner {
      display: inline-block;
      width: 1.5rem;
      height: 1.5rem;
      vertical-align: middle;
      border: 0.2em solid currentColor;
      border-right-color: transparent;
      border-radius: 50%;
      animation: spinner 0.75s linear infinite;
    }
    @keyframes spinner {
      to { transform: rotate(360deg); }
    }
    .barcode-container {
      text-align: center;
      margin-top: 1rem;
    }
    svg.barcodeSvg {
      margin-top: 0.5rem;
      height: 80px;
      width: 320px;
      display: block;
    }
    .nav-tabs .nav-link {
      cursor: pointer;
    }
    .barcode-item {
      border: 1px solid #ddd;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1rem;
      background: #fafafa;
      box-shadow: 0 0.05rem 0.15rem rgba(0,0,0,0.05);
    }
    .barcode-item h6 {
      margin-bottom: 0.5rem;
      word-break: break-word;
    }
    .barcode-list {
      max-height: 400px;
      overflow-y: auto;
    }
    .btn-group-sm > .btn {
      min-width: 100px;
    }
    form {
      max-width: 100%;
    }
    .record-list {
      overflow-x: auto;
    }
    .btn-export-pdf {
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <div id="app" class="container">
    <h3><i class="bi bi-upc-scan me-2"></i>出入庫管理 (掃碼)</h3>

    <div v-if="authError" class="alert alert-danger">{{ authError }}</div>

    <div v-if="token && !authError" style="flex-grow:1; display:flex; flex-direction:column;">
      <ul class="nav nav-tabs mb-3 flex-shrink-0">
        <li class="nav-item">
          <a class="nav-link" :class="{active: currentPage==='barcode'}" @click.prevent="currentPage='barcode'">條碼製作</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" :class="{active: currentPage==='scan'}" @click.prevent="currentPage='scan'">掃碼出入庫</a>
        </li>
      </ul>

      <div v-show="currentPage==='scan'" style="flex-grow:1; display:flex; flex-direction:column; overflow:hidden;">
        <form @submit.prevent="submitRecord" class="mb-3 flex-shrink-0">
          <div class="mb-3">
            <label for="barcodeInput" class="form-label">請掃描或輸入物料條碼</label>
            <input id="barcodeInput" v-model="barcode" @keyup.enter="fetchMaterialByBarcode" class="form-control scan-input" placeholder="掃描條碼後按 Enter" autocomplete="off" :disabled="loading" />
          </div>

          <div v-if="material" class="mb-3">
            <h5>物料資訊</h5>
            <ul class="list-group">
              <li class="list-group-item"><strong>物料編號:</strong> {{ material.item_id }}</li>
              <li class="list-group-item"><strong>名稱:</strong> {{ material.name }}</li>
              <li class="list-group-item"><strong>分類:</strong> {{ material.category }}</li>
              <li class="list-group-item"><strong>當前庫存:</strong> {{ material.current_stock }} {{ material.unit }}</li>
              <li class="list-group-item"><strong>安全庫存:</strong> {{ material.safety_stock }} {{ material.unit }}</li>
            </ul>
          </div>

          <div v-if="material" class="row g-3 align-items-center mb-3">
            <div class="col-auto">
              <label for="inOutSelect" class="col-form-label">操作類型</label>
            </div>
            <div class="col-auto">
              <select id="inOutSelect" v-model="recordType" class="form-select" :disabled="loading">
                <option value="in">入庫</option>
                <option value="out">出庫</option>
              </select>
            </div>
            <div class="col-auto">
              <label for="quantityInput" class="col-form-label">數量</label>
            </div>
            <div class="col-auto" style="max-width: 120px;">
              <input id="quantityInput" type="number" min="1" v-model.number="quantity" class="form-control" :disabled="loading" required />
            </div>
            <div class="col-auto">
              <button type="submit" class="btn btn-primary" :disabled="loading">
                {{ loading ? '處理中...' : '確認' }}
                <span v-if="loading" class="loading-spinner ms-2"></span>
              </button>
            </div>
          </div>
        </form>

        <div v-if="message" :class="['alert', messageType === 'success' ? 'alert-success' : 'alert-danger']" role="alert" style="flex-shrink:0;">
          {{ message }}
        </div>

        <div class="record-list" v-if="records.length > 0" style="flex-grow:1;">
          <h5>近期出入庫紀錄</h5>
          <table class="table table-striped table-bordered table-hover">
            <thead class="table-light">
              <tr>
                <th>時間</th>
                <th>物料編號</th>
                <th>名稱</th>
                <th>操作</th>
                <th>數量</th>
                <th>操作人員</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="rec in records" :key="rec.id">
                <td>{{ formatDateTime(rec.timestamp) }}</td>
                <td>{{ rec.item_id }}</td>
                <td>{{ rec.name }}</td>
                <td>
                  <span :class="rec.type === 'in' ? 'text-success' : 'text-danger'">
                    {{ rec.type === 'in' ? '入庫' : '出庫' }}
                  </span>
                </td>
                <td>{{ rec.quantity }}</td>
                <td>{{ rec.operator || '系統' }}</td>
              </tr>
            </tbody>
          </table>
          <button class="btn btn-outline-secondary btn-sm btn-clear" @click="clearRecords">清除紀錄</button>
        </div>
      </div>

      <div v-show="currentPage==='barcode'">
        <h5>條碼製作</h5>

        <div class="mb-3 d-flex gap-2 flex-wrap align-items-center">
          <button class="btn btn-success" @click="generateAllBarcodes" :disabled="barcodeLoading || materials.length === 0">
            {{ barcodeLoading ? '製作中...' : '一鍵全部製作' }}
            <span v-if="barcodeLoading" class="loading-spinner ms-2"></span>
          </button>
          <button class="btn btn-info btn-export-pdf" @click="exportBarcodesWithTextToPdf" :disabled="allBarcodesGenerated.length === 0 || barcodeLoading">
            <i class="bi bi-file-earmark-pdf-fill me-1"></i>匯出含中文字條碼PDF
          </button>
        </div>
        
        <div v-if="barcodeError" class="alert alert-danger">{{ barcodeError }}</div>

        <div v-if="allBarcodesGenerated.length > 0" class="barcode-list">
          <h6>全部條碼製作結果</h6>
          <div v-for="item in allBarcodesGenerated" :key="item.item_id" class="barcode-item">
            <h6>{{ item.name }} (編號: {{ item.item_id }})</h6>
            <svg :id="'barcodeSvgAll-' + item.item_id" class="barcodeSvg"></svg>
            <div class="mt-2"><strong>條碼編號：</strong>{{ item.barcode || '-' }}</div>
          </div>
        </div>
      </div>
    </div>

    <div v-else>
      <div class="alert alert-warning text-center">
        尚未授權，請先登入系統以取得操作權限。
      </div>
    </div>
  </div>

  <script>
    const { createApp, nextTick } = Vue;
    const { jsPDF } = window.jspdf;

    createApp({
      data() {
        return {
          apiBaseUrl: localStorage.getItem('apiBaseUrl') || 'http://10.10.7.66:5000/api',
          token: localStorage.getItem('apiKey') || '',
          authError: '',
          barcode: '',
          material: null,
          recordType: 'in',
          quantity: 1,
          loading: false,
          message: '',
          messageType: 'success',
          records: [],
          currentPage: 'scan',
          barcodeLoading: false,
          barcodeError: '',
          materials: [],
          allBarcodesGenerated: [],
          resizeObserver: null,
        };
      },
      async mounted() {
        const storedToken = localStorage.getItem('apiKey');
        
        if (!storedToken) {
            this.authError = '尚未取得授權，請確保已從主頁面登入。';
            this.token = '';
            localStorage.removeItem('apiKey');
        } else {
            this.token = storedToken;
            this.authError = '';
            try {
                await this.loadMaterials();  
            } catch (e) {
                console.error('Error during initial material load:', e);
            }
        }
        
        this.loadRecords();
        this.setupResizeObserver();
      },
      beforeUnmount() {
        if (this.resizeObserver) {
          this.resizeObserver.disconnect();
        }
      },
      watch: {
          currentPage() {
              this.sendHeightToParent();
          }
      },
      methods: {
        sendHeightToParent() {
          nextTick(() => {
            const newHeight = document.documentElement.scrollHeight;
            parent.postMessage({ type: 'adjustHeight', height: newHeight }, '*');
          });
        },
        
        setupResizeObserver() {
            if ('ResizeObserver' in window) {
                this.resizeObserver = new ResizeObserver(() => {
                    this.sendHeightToParent();
                });
                this.resizeObserver.observe(this.$el);
            }
            this.sendHeightToParent();
        },

        async loadMaterials() {
          try {
            const res = await axios.get(`${this.apiBaseUrl.replace(/\/$/, '')}/materials`, {
              headers: { Authorization: `Bearer ${this.token}` }
            });
            this.materials = res.data || [];
            this.authError = '';
            return this.materials;
          } catch (e) {
            console.error('取得物料列表失敗', e);
            this.materials = [];
            if (e.response && e.response.status === 401) {
                this.authError = '授權失效，請重新登入系統獲取新的Token。';
                this.token = '';
                localStorage.removeItem('apiKey');
            } else {
                this.authError = '無法連接後端服務或載入資料，請檢查API網址或網路連線。';
            }
            throw e;
          }
        },

        async fetchMaterialByBarcode() {
          this.message = '';
          this.material = null;
          if (!this.barcode.trim()) {
            this.message = '請輸入或掃描條碼';
            this.messageType = 'error';
            return;
          }
          this.loading = true;
          try {
            const res = await axios.get(`${this.apiBaseUrl.replace(/\/$/, '')}/materials/barcode/${encodeURIComponent(this.barcode.trim())}`, {
              headers: { Authorization: `Bearer ${this.token}` }
            });
            if (res.data) {
              this.material = res.data;
              this.message = '';
              this.quantity = 1;
            } else {
              this.message = '找不到對應的物料資料';
              this.messageType = 'error';
            }
          } catch (error) {
            this.message = '查詢物料失敗，請稍後再試';
            this.messageType = 'error';
          } finally {
            this.loading = false;
            this.sendHeightToParent();
          }
        },

        async submitRecord() {
          this.message = '';
          if (!this.material) {
            this.message = '請先掃描並選擇物料';
            this.messageType = 'error';
            return;
          }
          if (!this.quantity || this.quantity < 1) {
            this.message = '數量必須大於等於1';
            this.messageType = 'error';
            return;
          }
          this.loading = true;
          try {
            const payload = {
              item_id: this.material.item_id,
              type: this.recordType,
              quantity: this.quantity
            };
            const res = await axios.post(`${this.apiBaseUrl.replace(/\/$/, '')}/barcode/record`, payload, {
              headers: { Authorization: `Bearer ${this.token}` }
            });
            if (res.data && res.data.success) {
              this.message = `成功記錄${this.recordType === 'in' ? '入庫' : '出庫'} ${this.quantity} ${this.material.unit}。`;
              this.messageType = 'success';
              await this.fetchMaterialByBarcode();

              const recordQuantity = (res.data.record && typeof res.data.record.quantity === 'number') ? res.data.record.quantity : this.quantity;

              this.addRecordToList({
                id: Date.now(),
                timestamp: new Date().toISOString(),
                item_id: res.data.material.item_id,
                name: res.data.material.name,
                type: this.recordType,
                quantity: recordQuantity,
                operator: '使用者'
              });
              this.barcode = '';
              this.quantity = 1;
              if (window.parent !== window) {
                window.parent.postMessage({ type: 'inventoryUpdated' }, '*');  
              }
            } else {
              this.message = res.data.message || '操作失敗，請稍後再試';
              this.messageType = 'error';
            }
          } catch (error) {
            console.error('submitRecord error:', error.response || error);
            if (error.response && error.response.data && error.response.data.error) {
              this.message = error.response.data.error;
            } else {
              this.message = '送出失敗，請稍後再試';
            }
            this.messageType = 'error';
          } finally {
            this.loading = false;
            this.sendHeightToParent();
          }
        },

        addRecordToList(record) {
          this.records.unshift(record);
          if (this.records.length > 50) {
            this.records.splice(50);
          }
          this.saveRecords();
        },

        saveRecords() {
          localStorage.setItem('inBarcodeRecords', JSON.stringify(this.records));
        },

        loadRecords() {
          const saved = localStorage.getItem('inBarcodeRecords');
          if (saved) {
            try {
              this.records = JSON.parse(saved);
            } catch {
              this.records = [];
            }
          }
        },

        clearRecords() {
          if (confirm('確定要清除所有出入庫紀錄嗎？')) {
            this.records = [];
            this.saveRecords();
            if (window.parent !== window) {
              window.parent.postMessage({ type: 'inventoryUpdated' }, '*');
            }
          }
        },

        formatDateTime(dateStr) {
          const d = new Date(dateStr);
          if (isNaN(d)) return dateStr;
          return d.toLocaleString();
        },

        async generateAllBarcodes() {
          try {
            this.barcodeError = '';
            this.allBarcodesGenerated = [];
            let barcodeMissingCount = 0;
            let svgElementNotFoundCount = 0;

            if (this.materials.length === 0) {
              this.barcodeError = '無物料資料可製作條碼';
              return;
            }
            this.barcodeLoading = true;
            await nextTick();

            this.allBarcodesGenerated = [...this.materials];
            await nextTick();

            // 清空所有SVG內容，避免重複繪製
            this.allBarcodesGenerated.forEach(item => {
              const svgId = 'barcodeSvgAll-' + item.item_id;
              const svgElement = document.getElementById(svgId);
              if (svgElement) svgElement.innerHTML = '';
            });

            for (const item of this.allBarcodesGenerated) {
              const svgId = 'barcodeSvgAll-' + item.item_id;
              const svgElement = document.getElementById(svgId);

              if (!svgElement) {
                console.error(`SVG element ${svgId} not found for item ${item.item_id}. Skipping barcode generation.`);
                svgElementNotFoundCount++;
                continue;
              }

              if (!item.barcode) {
                console.warn(`物料編號 ${item.item_id} 缺少條碼資料，跳過製作條碼圖形。`);
                barcodeMissingCount++;
                continue;
              }

              try {
                // 先清空
                svgElement.innerHTML = '';

                JsBarcode(`#${svgId}`, item.barcode, {
                  format: "code128",
                  lineColor: "#4a6fdc",
                  width: 2,
                  height: 80,
                  displayValue: true,
                  fontSize: 16,
                  font: "monospace",  // 強制字型
                  margin: 10
                });

                await nextTick();
                await new Promise(resolve => setTimeout(resolve, 50)); // 等待渲染

              } catch (innerError) {
                console.error(`Error processing barcode for item ${item.item_id}:`, innerError);
              }
            }

            if (barcodeMissingCount > 0 || svgElementNotFoundCount > 0) {
              this.barcodeError = `有 ${barcodeMissingCount} 個物料缺少條碼資料，${svgElementNotFoundCount} 個條碼圖形元素未找到。`;
            } else {
              this.barcodeError = '';
            }
          } catch (e) {
            console.error('generateAllBarcodes error:', e);
            this.barcodeError = '一鍵全部製作過程中發生未知錯誤，請稍後再試。';
          } finally {
            this.barcodeLoading = false;
            this.sendHeightToParent();
          }
        },

        async exportBarcodesWithTextToPdf() {
          if (this.allBarcodesGenerated.length === 0) {
            alert('沒有可匯出的條碼。請先製作條碼。');
            return;
          }

          const doc = new jsPDF({
            unit: 'pt',
            format: 'a4'
          });
          
          // 設定中文字型
          // 'cwkai' 是 jspdf-font-standard-chinese 提供的其中一個字型別名
          // 您也可以選擇 'wqy-zenhei' 或其他該庫支援的字型
          doc.setFont('cwkai'); // 設定字型為 'cwkai' (楷書)

          const margin = 40;
          const pageWidth = doc.internal.pageSize.getWidth();
          const pageHeight = doc.internal.pageSize.getHeight();

          let yOffset = margin;
          const lineHeight = 18;
          const barcodeImgHeight = 100; // 調整高度以包含文字
          const barcodeImgWidth = 320;
          const spacing = 20;

          for (const item of this.allBarcodesGenerated) {
            const neededHeight = lineHeight * 3 + barcodeImgHeight + spacing;
            if (yOffset + neededHeight > pageHeight - margin) {
              doc.addPage();
              yOffset = margin;
              doc.setFont('cwkai'); // 換頁後也要重新設定字型
            }

            // 文字部分
            doc.setFontSize(12);
            doc.setTextColor(20, 20, 20);
            doc.text(`物料名稱: ${item.name}`, margin, yOffset);
            yOffset += lineHeight;
            doc.text(`物料編號: ${item.item_id}`, margin, yOffset);
            yOffset += lineHeight;
            doc.text(`條碼編號: ${item.barcode || '-'}`, margin, yOffset);
            yOffset += lineHeight + 5;

            // 取得 SVG 元素
            const svgId = 'barcodeSvgAll-' + item.item_id;
            const svgElement = document.getElementById(svgId);
            if (svgElement) {
              try {
                // 將 SVG 轉成 XML 字串
                const svgData = new XMLSerializer().serializeToString(svgElement);

                // 建立 Canvas
                const canvas = document.createElement('canvas');
                canvas.width = 320;
                canvas.height = 100;
                const ctx = canvas.getContext('2d');

                // 建立 Image 元素
                const img = new Image();

                // 將 SVG 轉為 Data URL
                const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(svgBlob);

                await new Promise((resolve, reject) => {
                  img.onload = () => {
                    // 清空 Canvas
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    // 繪製圖片到 Canvas
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    URL.revokeObjectURL(url);
                    resolve();
                  };
                  img.onerror = (e) => {
                    URL.revokeObjectURL(url);
                    console.warn('SVG 轉圖片載入失敗', e);
                    resolve(); // 失敗也繼續
                  };
                  img.src = url;
                });

                // 取得 Canvas Data URL
                const imgData = canvas.toDataURL('image/png');

                // 加入 PDF
                doc.addImage(imgData, 'PNG', (pageWidth - barcodeImgWidth) / 2, yOffset, barcodeImgWidth, barcodeImgHeight);
                yOffset += barcodeImgHeight + spacing;

              } catch (e) {
                console.warn(`匯出條碼圖片失敗: ${item.item_id}`, e);
                yOffset += barcodeImgHeight + spacing;
              }
            } else {
              yOffset += barcodeImgHeight + spacing;
            }
          }

          doc.save('barcodes_with_text.pdf');
        }
      }
    }).mount('#app');
  </script>
</body>
</html>