<!DOCTYPE html> 
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>æ ¡åœ’ç‰©æ–™ç®¡ç†ç³»çµ±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/vue@3.2.47/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-light">
<div id="app" class="container py-4">
  <h2 class="text-center mb-4">ğŸ« æ ¡åœ’ç‰©æ–™ç®¡ç†ç³»çµ±</h2>

  <!-- ç™»å…¥/è¨»å†Šè¡¨å–®åˆ‡æ› -->
  <div v-if="!token" class="card mx-auto" style="max-width: 400px;">
    <div class="card-body">
      <h5 class="card-title">
        {{ isRegister ? 'ğŸ“ è¨»å†Šå¸³è™Ÿ' : 'ğŸ” ç™»å…¥ç³»çµ±' }}
      </h5>

      <!-- ç™»å…¥è¡¨å–® -->
      <div v-if="!isRegister">
        <input v-model="username" placeholder="å¸³è™Ÿ" class="form-control mb-2" />
        <input v-model="password" placeholder="å¯†ç¢¼" type="password" class="form-control mb-2" />
        <button @click="login" class="btn btn-primary w-100">ç™»å…¥</button>
        <div class="text-danger mt-2" v-if="loginError">{{ loginError }}</div>
      </div>

      <!-- è¨»å†Šè¡¨å–® -->
      <div v-else>
        <input v-model="username" placeholder="å¸³è™Ÿ" class="form-control mb-2" />
        <input v-model="password" placeholder="å¯†ç¢¼" type="password" class="form-control mb-2" />
        <input v-model="confirmPassword" placeholder="ç¢ºèªå¯†ç¢¼" type="password" class="form-control mb-2" />
        <button @click="register" class="btn btn-success w-100">è¨»å†Š</button>
        <div class="text-danger mt-2" v-if="registerError">{{ registerError }}</div>
        <div class="text-success mt-2" v-if="registerSuccess">{{ registerSuccess }}</div>
      </div>

      <button @click="toggleForm" class="btn btn-link mt-3 w-100">
        {{ isRegister ? "â† è¿”å›ç™»å…¥" : "æ²’æœ‰å¸³è™Ÿï¼Ÿè¨»å†Š" }}
      </button>
    </div>
  </div>

  <!-- ç™»å…¥å¾Œä¸»ç•«é¢ -->
  <div v-else>
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0">ğŸ“¦ ç‰©æ–™æ¸…å–®</h5>
      <div>
        <button @click="fetchMaterials" class="btn btn-outline-secondary btn-sm me-2">é‡æ–°è¼‰å…¥</button>
        <button @click="logout" class="btn btn-outline-danger btn-sm">ç™»å‡º</button>
      </div>
    </div>

    <!-- æ–°å¢/ç·¨è¼¯è¡¨å–® -->
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">{{ isEditing ? 'âœï¸ ç·¨è¼¯ç‰©æ–™' : 'â• æ–°å¢ç‰©æ–™' }}</h5>
        <div class="row g-2">
          <div class="col-md-4">
            <input v-model="form.item_id" :readonly="isEditing" required class="form-control" placeholder="ç‰©æ–™ç·¨è™Ÿ">
          </div>
          <div class="col-md-4">
            <input v-model="form.name" required class="form-control" placeholder="åç¨±">
          </div>
          <div class="col-md-4">
            <input v-model="form.unit" required class="form-control" placeholder="å–®ä½">
          </div>
          <div class="col-md-4">
            <input v-model="form.category" required class="form-control" placeholder="åˆ†é¡">
          </div>
          <div class="col-md-4">
            <input v-model="form.safety_stock" required type="number" class="form-control" placeholder="å®‰å…¨åº«å­˜">
          </div>
          <div class="col-md-4">
            <input v-model="form.notes" class="form-control" placeholder="å‚™è¨»">
          </div>
        </div>
        <button @click="submitMaterial" class="btn btn-success mt-3">{{ isEditing ? 'æ›´æ–°' : 'æ–°å¢' }}</button>
        <button v-if="isEditing" @click="cancelEdit" class="btn btn-secondary mt-3 ms-2">å–æ¶ˆç·¨è¼¯</button>
        <div class="text-success mt-2" v-if="submitMessage">{{ submitMessage }}</div>
      </div>
    </div>

    <!-- ç‰©æ–™è¡¨æ ¼ -->
    <div v-if="materials.length === 0" class="alert alert-info">ç›®å‰ç„¡ç‰©æ–™è³‡æ–™</div>
    <div v-else class="table-responsive">
      <table class="table table-bordered align-middle">
        <thead class="table-light">
          <tr><th>ç·¨è™Ÿ</th><th>åç¨±</th><th>åˆ†é¡</th><th>åº«å­˜</th><th>å–®ä½</th><th>å®‰å…¨åº«å­˜</th><th>å‚™è¨»</th><th>æ“ä½œ</th></tr>
        </thead>
        <tbody>
          <tr v-for="item in materials" :key="item.item_id">
            <td>{{ item.item_id }}</td><td>{{ item.name }}</td><td>{{ item.category }}</td>
            <td>{{ item.current_stock }}</td><td>{{ item.unit }}</td><td>{{ item.safety_stock }}</td><td>{{ item.notes }}</td>
            <td>
              <button @click="editMaterial(item)" class="btn btn-sm btn-warning me-1">ç·¨è¼¯</button>
              <button @click="confirmDelete(item)" class="btn btn-sm btn-danger">åˆªé™¤</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- åˆªé™¤ç¢ºèª Modal -->
  <div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">åˆªé™¤ç¢ºèª</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          ç¢ºå®šè¦åˆªé™¤ç‰©æ–™ã€Œ{{ deleteTarget?.name }}ã€ï¼Ÿ
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-danger" @click="deleteMaterial">åˆªé™¤</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const { createApp } = Vue;
createApp({
  data() {
    return {
      api: "http://127.0.0.1:5000",
      username: "",
      password: "",
      confirmPassword: "",
      token: localStorage.getItem("token") || "",
      loginError: "",
      registerError: "",
      registerSuccess: "",
      materials: [],
      submitMessage: "",
      isRegister: false,
      isEditing: false,
      deleteTarget: null,
      form: { item_id: "", name: "", unit: "", category: "", safety_stock: 0, notes: "" },
    };
  },
  mounted() {
    if (this.token) this.fetchMaterials();
  },
  methods: {
    toggleForm() {
      this.isRegister = !this.isRegister;
      this.loginError = "";
      this.registerError = "";
      this.registerSuccess = "";
      this.username = "";
      this.password = "";
      this.confirmPassword = "";
    },
    async login() {
      this.loginError = "";
      if (!this.username || !this.password) {
        this.loginError = "è«‹è¼¸å…¥å¸³è™Ÿå’Œå¯†ç¢¼";
        return;
      }
      try {
        const res = await axios.post(`${this.api}/api/login`, {
          username: this.username,
          password: this.password
        });
        this.token = res.data.access_token;
        localStorage.setItem("token", this.token);
        this.fetchMaterials();
      } catch (err) {
        this.loginError = "ç™»å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªå¸³å¯†";
      }
    },
    async register() {
      this.registerError = "";
      this.registerSuccess = "";
      if (!this.username || !this.password || !this.confirmPassword) {
        this.registerError = "è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½";
        return;
      }
      if (this.password !== this.confirmPassword) {
        this.registerError = "å¯†ç¢¼èˆ‡ç¢ºèªå¯†ç¢¼ä¸ç¬¦";
        return;
      }
      try {
        await axios.post(`${this.api}/api/register`, {
          username: this.username,
          password: this.password
        });
        this.registerSuccess = "è¨»å†ŠæˆåŠŸï¼Œè«‹ç™»å…¥";
        setTimeout(() => {
          this.toggleForm();
        }, 2000);
      } catch (err) {
        this.registerError = "è¨»å†Šå¤±æ•—ï¼š" + (err.response?.data?.error || err.message);
      }
    },
    logout() {
      this.token = "";
      localStorage.removeItem("token");
    },
    async fetchMaterials() {
      try {
        const res = await axios.get(`${this.api}/api/materials`, {
          headers: { Authorization: `Bearer ${this.token}` }
        });
        this.materials = res.data;
      } catch (err) {
        console.error("è³‡æ–™è¼‰å…¥å¤±æ•—", err);
      }
    },
    async submitMaterial() {
      try {
        if (this.isEditing) {
          await axios.put(`${this.api}/api/materials/${this.form.item_id}`, this.form, {
            headers: { Authorization: `Bearer ${this.token}` }
          });
        } else {
          await axios.post(`${this.api}/api/materials`, this.form, {
            headers: { Authorization: `Bearer ${this.token}` }
          });
        }
        this.submitMessage = this.isEditing ? "âœ… æ›´æ–°æˆåŠŸï¼" : "âœ… æ–°å¢æˆåŠŸï¼";
        this.fetchMaterials();
        this.cancelEdit();
      } catch (err) {
        this.submitMessage = "âŒ æ“ä½œå¤±æ•—ï¼š" + (err.response?.data?.error || err.message);
      }
    },
    editMaterial(item) {
      this.form = { ...item };
      this.isEditing = true;
    },
    cancelEdit() {
      this.isEditing = false;
      this.form = { item_id: "", name: "", unit: "", category: "", safety_stock: 0, notes: "" };
    },
    confirmDelete(item) {
      this.deleteTarget = item;
      new bootstrap.Modal(document.getElementById('deleteModal')).show();
    },
    async deleteMaterial() {
      try {
        await axios.delete(`${this.api}/api/materials/${this.deleteTarget.item_id}`, {
          headers: { Authorization: `Bearer ${this.token}` }
        });
        this.fetchMaterials();
        this.deleteTarget = null;
        bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
      } catch (err) {
        alert("åˆªé™¤å¤±æ•—: " + (err.response?.data?.error || err.message));
      }
    }
  }
}).mount("#app");
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>