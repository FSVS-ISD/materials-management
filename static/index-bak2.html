<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>校園物料管理系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/vue@3.3.11/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.2/dist/axios.min.js"></script>
    <style>
        body, html {
            height: 100%;
            background-color: #f0f2f5;
        }
        #app {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .main-content {
            flex-grow: 1;
            overflow-y: auto;
        }
        .card, .list-group-item {
            border-radius: 0.75rem;
        }
        .list-group-item.active {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
        .iframe-container {
            width: 100%;
            height: calc(100vh - 80px); /* Adjust height based on navbar */
            border: none;
            border-radius: 0.75rem;
            overflow: hidden;
            background-color: white;
            box-shadow: 0 0.125rem 0.75rem rgba(0,0,0,0.07);
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        /* Login Page Styles */
        .login-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }
        .login-card {
             width: 100%;
             max-width: 420px;
        }
        #connectionTest {
            width: 100%;
            max-width: 420px;
            margin-top: 1.5rem;
            padding: 1.5rem;
            border: 1px solid #dee2e6;
            border-radius: .75rem;
            background-color: #fff;
        }
        #connectionTest .result {
            margin-top: 1rem;
            font-weight: bold;
            text-align: center;
        }
    </style>
</head>
<body>

<div id="app">
    <!-- 登入畫面 -->
    <div v-if="!isAuthenticated" class="login-wrapper">
        <div class="login-card">
            <div class="card shadow-sm">
                <div class="card-body p-4 p-md-5">
                    <h3 class="card-title text-center mb-4">校園物料管理系統</h3>
                    <form @submit.prevent="login">
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="username" placeholder="使用者名稱" v-model="authForm.username" required>
                            <label for="username">使用者名稱</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="password" class="form-control" id="password" placeholder="密碼" v-model="authForm.password" required>
                            <label for="password">密碼</label>
                        </div>
                        
                        <div v-if="authError" class="alert alert-danger p-2 text-center">{{ authError }}</div>

                        <div class="d-grid mt-4">
                            <button class="btn btn-primary btn-lg" type="submit" :disabled="authLoading">
                                <span v-if="authLoading" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                {{ authLoading ? ' 登入中...' : '登入' }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- API連線測試區塊 -->
        <div id="connectionTest">
            <h4 class="text-center mb-3">後端 API 連線測試</h4>
            <div class="mb-2">
                <input type="text" class="form-control form-control-sm" v-model="testApiUrl" placeholder="API 網址，例如 http://10.10.7.66:5000/api" />
            </div>
            <div class="mb-3">
                <input type="text" class="form-control form-control-sm" v-model="testApiKey" placeholder="API 密鑰 (Token)" />
            </div>
            <div class="d-grid">
                <button @click="testConnection" class="btn btn-info" :disabled="testLoading">
                     <span v-if="testLoading" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    {{ testLoading ? '測試中...' : '測試連線' }}
                </button>
            </div>
            <div v-if="testResultMessage" class="result" :style="{ color: testResultColor }">{{ testResultMessage }}</div>
        </div>
    </div>

    <!-- 主應用程式介面 -->
    <div v-else class="d-flex flex-column h-100">
        <header class="navbar navbar-dark bg-primary shadow-sm">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">
                    <i class="bi bi-boxes-fill me-2"></i>
                    校園物料管理系統
                </a>
                <div class="d-flex align-items-center text-white">
                    <i class="bi bi-person-circle me-2"></i>
                    <span>歡迎，{{ loggedInUser }}</span>
                    <button @click="logout" class="btn btn-outline-light btn-sm ms-3">
                        <i class="bi bi-box-arrow-right"></i> 登出
                    </button>
                </div>
            </div>
        </header>

        <div class="main-content container-fluid mt-3">
            <div class="row">
                <div class="col-md-3 col-lg-2">
                    <div class="list-group">
                         <a href="#" class="list-group-item list-group-item-action" :class="{active: currentView === 'login_portal'}" @click.prevent="switchView('login_portal')"><i class="bi bi-grid-1x2-fill me-2"></i>功能總覽</a>
                         <a href="#" class="list-group-item list-group-item-action" :class="{active: currentView === 'material_management'}" @click.prevent="switchView('material_management')"><i class="bi bi-box-seam me-2"></i>物料管理</a>
                         <a href="#" class="list-group-item list-group-item-action" :class="{active: currentView === 'inbound_outbound'}" @click.prevent="switchView('inbound_outbound')"><i class="bi bi-input-cursor-text me-2"></i>出入庫(手動)</a>
                         <a href="#" class="list-group-item list-group-item-action" :class="{active: currentView === 'scan_barcode'}" @click.prevent="switchView('scan_barcode')"><i class="bi bi-upc-scan me-2"></i>出入庫(掃碼)</a>
                         <a href="#" class="list-group-item list-group-item-action" :class="{active: currentView === 'inventory_summary'}" @click.prevent="switchView('inventory_summary')"><i class="bi bi-clipboard-check me-2"></i>庫存管理</a>
                         <a href="#" class="list-group-item list-group-item-action" :class="{active: currentView === 'report_center'}" @click.prevent="switchView('report_center')"><i class="bi bi-file-earmark-bar-graph me-2"></i>報表中心</a>
                    </div>
                </div>
                <div class="col-md-9 col-lg-10">
                    <div class="iframe-container">
                        <iframe ref="contentFrame" :src="iframeSrc" title="功能頁面"></iframe>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, onMounted, computed, watch } = Vue;

    createApp({
        setup() {
            const apiUrl = 'http://10.10.7.66:5000/api';
            
            const isAuthenticated = ref(false);
            const token = ref(localStorage.getItem('token') || null);
            const loggedInUser = ref(localStorage.getItem('username') || '');
            
            const authForm = ref({ username: '', password: '' });
            const authLoading = ref(false);
            const authError = ref('');

            const currentView = ref('login_portal');

            // API 測試相關的 ref
            const testApiUrl = ref(apiUrl);
            const testApiKey = ref(token.value || '');
            const testLoading = ref(false);
            const testResultMessage = ref('');
            const testResultColor = ref('black');

            watch(token, (newToken) => {
                testApiKey.value = newToken || '';
            });

            const verifyToken = async () => {
                if (!token.value) {
                    isAuthenticated.value = false;
                    return;
                }
                try {
                    await axios.get(`${apiUrl}/materials`, {
                        headers: { 'Authorization': `Bearer ${token.value}` }
                    });
                    isAuthenticated.value = true;
                } catch (error) {
                    isAuthenticated.value = false;
                    localStorage.removeItem('token');
                    localStorage.removeItem('username');
                    token.value = null;
                }
            };
            
            onMounted(() => {
                verifyToken();
            });

            const login = async () => {
                if (!authForm.value.username || !authForm.value.password) {
                    authError.value = '請輸入帳號和密碼。';
                    return;
                }
                authLoading.value = true;
                authError.value = '';
                try {
                    const response = await axios.post(`${apiUrl}/login`, {
                        username: authForm.value.username,
                        password: authForm.value.password
                    });
                    
                    token.value = response.data.access_token;
                    loggedInUser.value = authForm.value.username;
                    
                    localStorage.setItem('token', token.value);
                    localStorage.setItem('username', loggedInUser.value);
                    
                    isAuthenticated.value = true;
                    currentView.value = 'login_portal';

                } catch (err) {
                    authError.value = `登入失敗：${err.response?.data?.error || err.message}`;
                } finally {
                    authLoading.value = false;
                }
            };

            const logout = () => {
                token.value = null;
                loggedInUser.value = '';
                authForm.value.username = '';
                authForm.value.password = '';
                isAuthenticated.value = false;
                localStorage.removeItem('token');
                localStorage.removeItem('username');
            };

            const switchView = (viewName) => {
                currentView.value = viewName;
            };

            const iframeSrc = computed(() => {
                if (!isAuthenticated.value) return '';

                const pageMap = {
                    login_portal: 'login.html',
                    material_management: 'material-management.html',
                    inbound_outbound: 'Inbound and outbound.html',
                    scan_barcode: 'scan-barcode.html',
                    inventory_summary: 'Inventory summary.html',
                    report_center: 'report-center.html'
                };
                
                const page = pageMap[currentView.value] || 'login.html';
                return `${page}?token=${encodeURIComponent(token.value)}`;
            });

            const testConnection = async () => {
                if (!testApiUrl.value) {
                    testResultMessage.value = '請輸入 API 網址。';
                    testResultColor.value = 'red';
                    return;
                }
                testLoading.value = true;
                testResultMessage.value = '';
                try {
                    await axios.get(`${testApiUrl.value}/health`, {
                        headers: { 
                            ...(testApiKey.value && { 'Authorization': `Bearer ${testApiKey.value}` })
                        },
                        timeout: 5000
                    });
                    testResultMessage.value = '✅ 連線成功！';
                    testResultColor.value = 'green';
                } catch (err) {
                     testResultMessage.value = `❌ 連線失敗: ${err.message}`;
                     if(err.response) {
                         testResultMessage.value += ` (狀態: ${err.response.status})`;
                     }
                    testResultColor.value = 'red';
                } finally {
                    testLoading.value = false;
                }
            };

            return {
                isAuthenticated,
                authForm,
                authLoading,
                authError,
                loggedInUser,
                currentView,
                iframeSrc,
                testApiUrl,
                testApiKey,
                testLoading,
                testResultMessage,
                testResultColor,
                login,
                logout,
                switchView,
                testConnection
            };
        }
    }).mount('#app');
</script>

</body>
</html>